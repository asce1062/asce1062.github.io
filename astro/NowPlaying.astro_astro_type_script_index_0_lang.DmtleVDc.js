import{m as l}from"./musicPlayer.CE6cfaWF.js";import"./music.CNPadTJM.js";class h{collapsedElement;expandedElement;expandedContainer;sleepTimerButton;sleepTimerPopup;activeTimerModal;isVisible=!1;isExpanded=!1;isSleepTimerExpanded=!1;isActiveTimerVisible=!1;wasActiveTimerVisibleBeforeExpand=!1;footerObserver=null;sleepTimerInterval=null;sleepTimerEndTime=null;lastTimerDuration=null;sleepTimerPaused=!1;sleepTimerPausedAt=null;constructor(){this.collapsedElement=document.getElementById("now-playing-collapsed"),this.expandedElement=document.getElementById("now-playing-expanded"),this.expandedContainer=document.getElementById("now-playing-card"),this.sleepTimerButton=document.getElementById("sleep-timer-button"),this.sleepTimerPopup=document.getElementById("sleep-timer-popup"),this.activeTimerModal=document.getElementById("active-timer-modal"),!(!this.collapsedElement||!this.expandedElement)&&this.init()}init(){this.setupEventListeners(),this.setupSleepTimerEventListeners(),this.setupFooterOverlapPrevention(),this.bindMusicPlayerEvents();const e=l.getState();this.updateFromState(e),this.restoreSleepTimer()}setupEventListeners(){const e=document.getElementById("expand-now-playing"),t=document.getElementById("collapse-now-playing");e?.addEventListener("click",a=>{a.stopPropagation(),this.expand()}),t?.addEventListener("click",()=>this.collapse()),document.getElementById("collapsed-play-pause")?.addEventListener("click",a=>{a.stopPropagation(),this.togglePlayPause()}),this.collapsedElement?.addEventListener("click",()=>this.expand()),this.expandedElement?.addEventListener("click",a=>{a.target===this.expandedElement&&this.collapse()});const s=document.getElementById("expanded-play-pause"),n=document.getElementById("expanded-prev"),o=document.getElementById("expanded-next"),r=document.getElementById("expanded-loop");s?.addEventListener("click",()=>this.togglePlayPause()),n?.addEventListener("click",()=>l.previousTrack()),o?.addEventListener("click",()=>l.nextTrack()),r?.addEventListener("click",()=>l.toggleLoop());const d=this.collapsedElement?.querySelector(".mini-progress-container-collapsed"),p=this.expandedElement?.querySelector(".expanded-progress-container");d?.addEventListener("click",a=>{a.stopPropagation(),this.handleProgressClick(a)}),p?.addEventListener("click",a=>this.handleProgressClick(a)),this.expandedElement?.querySelector(".expanded-volume-slider")?.addEventListener("input",a=>{const u=parseInt(a.target.value)/100;l.setVolume(u)}),document.addEventListener("keydown",a=>{if(!["INPUT","TEXTAREA"].includes(a.target.tagName))switch(a.key){case" ":a.preventDefault(),this.togglePlayPause();break;case"ArrowLeft":a.preventDefault(),l.previousTrack();break;case"ArrowRight":a.preventDefault(),l.nextTrack();break;case"l":case"L":a.preventDefault(),l.toggleLoop();break;case"Escape":this.isExpanded&&(a.preventDefault(),this.collapse());break}})}setupSleepTimerEventListeners(){document.getElementById("sleep-timer-toggle")?.addEventListener("click",()=>this.toggleSleepTimer()),document.getElementById("sleep-timer-close")?.addEventListener("click",()=>this.closeSleepTimer()),document.querySelectorAll(".sleep-timer-option").forEach(o=>{o.addEventListener("click",r=>{const d=parseInt(r.currentTarget.dataset.minutes||"0");this.selectSleepTimer(d)})}),document.getElementById("cancel-timer")?.addEventListener("click",()=>this.cancelSleepTimer()),document.getElementById("active-timer-close")?.addEventListener("click",()=>this.minimizeActiveTimerModal())}bindMusicPlayerEvents(){l.onTrackStarted(e=>{const{track:t,album:i}=e.detail;this.updateTrackInfo(t,i),this.show()}),l.onStateChanged(e=>{this.updateFromState(e.detail.state)}),l.onProgressUpdated(e=>{const{currentTime:t,duration:i,percentage:s}=e.detail;this.updateProgress(t,i,s)}),l.onVolumeChanged(e=>{this.updateVolumeDisplay(Math.round(e.detail.volume*100))}),l.onLoopChanged(e=>{this.updateLoopButton(e.detail.isLooping)}),l.onTrackChanged(e=>{const{track:t,album:i}=e.detail;this.updateTrackInfo(t,i)}),l.onTrackPaused(()=>{this.pauseSleepTimer()}),l.onTrackResumed(()=>{this.resumeSleepTimer()}),l.onStateChanged(e=>{const t=e.detail.state;this.sleepTimerEndTime&&!this.sleepTimerPaused?t.isPlaying||this.pauseSleepTimer():this.sleepTimerPaused&&t.isPlaying&&this.resumeSleepTimer()})}setupFooterOverlapPrevention(){this.footerObserver=new IntersectionObserver(i=>{i.forEach(s=>{this.updateWidgetPosition()})},{root:null,rootMargin:"0px",threshold:.1});const e=document.querySelector("footer");e&&this.footerObserver&&this.footerObserver.observe(e);let t=null;window.addEventListener("scroll",()=>{t&&clearTimeout(t),t=window.setTimeout(()=>{this.updateWidgetPosition()},10)}),window.addEventListener("resize",()=>{this.updateWidgetPosition()})}updateWidgetPosition(){if(!this.collapsedElement||!this.isVisible||this.isExpanded)return;const e=document.querySelector("footer");if(!e)return;const t=e.getBoundingClientRect(),i=window.innerHeight,s=16;let n=s;if(t.top<i&&(n=i-t.top+s+10),this.collapsedElement.style.bottom=`${n}px`,this.collapsedElement.style.transition="bottom 0.3s ease, opacity 0.3s ease, scale 0.2s cubic-bezier(0.4, 0, 0.2, 1)",this.sleepTimerButton&&(this.sleepTimerButton.style.bottom=`${n}px`,this.sleepTimerButton.style.transition="bottom 0.3s ease, opacity 0.3s ease"),this.sleepTimerPopup){const o=n+165;this.sleepTimerPopup.style.bottom=`${o}px`,this.sleepTimerPopup.style.transition="bottom 0.3s ease, transform 0.3s ease"}if(this.activeTimerModal){const o=n+165;this.activeTimerModal.style.bottom=`${o}px`,this.activeTimerModal.style.transition="bottom 0.3s ease, transform 0.3s ease"}}updateFromState(e){e.currentTrack&&e.currentAlbum?(this.updateTrackInfo(e.currentTrack,e.currentAlbum),this.updatePlayButton(e.isPlaying),this.updateLoopButton(e.isLooping),this.updateVolumeSlider(e.volume),e.isVisible&&this.show()):this.isVisible&&this.hide()}updateTrackInfo(e,t){const i=this.collapsedElement?.querySelector(".now-playing-title-collapsed"),s=this.collapsedElement?.querySelector(".now-playing-album-collapsed");i&&(i.textContent=e.title||"Unknown Track",this.setupMarquee(i)),s&&(s.textContent=t.title||"Unknown Album",this.setupMarquee(s));const n=this.expandedElement?.querySelector(".now-playing-title-expanded"),o=this.expandedElement?.querySelector(".now-playing-album-expanded"),r=this.expandedElement?.querySelector(".now-playing-album-art"),d=this.expandedElement?.querySelector(".now-playing-release-date");if(n&&(n.textContent=e.title||"Unknown Track",this.setupMarquee(n)),o&&(o.textContent=t.title||"Unknown Album",this.setupMarquee(o)),r&&t&&(r.src=t.coverArt||"/art/default-cover.png",r.alt=`${t.title} album cover`),d&&t){const p=new Date(t.releaseDate).toLocaleDateString();d.textContent=`Released ${p}`}}setupMarquee(e){e.classList.remove("scrolling"),setTimeout(()=>{const t=e.parentElement;if(!t)return;const i=e.scrollWidth,s=t.clientWidth;i>s?(e.style.paddingRight="20px",e.classList.add("scrolling")):(e.style.paddingRight="0px",e.classList.remove("scrolling"))},100)}updateProgress(e,t,i){const s=this.collapsedElement?.querySelector(".mini-progress-bar-collapsed");s&&(s.style.width=`${i}%`);const n=this.expandedElement?.querySelector(".expanded-progress-bar"),o=this.expandedElement?.querySelector(".expanded-current-time"),r=this.expandedElement?.querySelector(".expanded-total-time");n&&(n.style.width=`${i}%`),o&&(o.textContent=this.formatTime(e)),r&&(r.textContent=this.formatTime(t))}updatePlayButton(e){const t=this.expandedElement?.querySelector(".expanded-play-icon"),i=this.expandedElement?.querySelector(".expanded-pause-icon"),s=this.collapsedElement?.querySelector(".collapsed-play-icon"),n=this.collapsedElement?.querySelector(".collapsed-pause-icon");e?(t&&(t.style.display="none"),i&&(i.style.display="inline-block"),s&&(s.style.display="none"),n&&(n.style.display="inline-block")):(t&&(t.style.display="inline-block"),i&&(i.style.display="none"),s&&(s.style.display="inline-block"),n&&(n.style.display="none"))}updateLoopButton(e){const t=this.expandedElement?.querySelector(".expanded-loop-icon"),i=this.expandedElement?.querySelector(".expanded-loop-one-icon"),s=this.expandedElement?.querySelector("#expanded-loop");e?(t&&(t.style.display="none"),i&&(i.style.display="inline-block"),s&&(s.classList.remove("text-palette-800","dark:text-palette-300"),s.classList.add("text-palette-800","dark:text-palette-400"),s.setAttribute("title","Loop Track (Active)"))):(t&&(t.style.display="inline-block"),i&&(i.style.display="none"),s&&(s.classList.add("text-palette-800","dark:text-palette-300"),s.classList.remove("text-palette-800","dark:text-palette-400"),s.setAttribute("title","Loop Track")))}updateVolumeSlider(e){const t=this.expandedElement?.querySelector(".expanded-volume-slider");t&&(t.value=(e*100).toString(),this.updateVolumeDisplay(Math.round(e*100)))}updateVolumeDisplay(e){const t=this.expandedElement?.querySelector(".expanded-volume-display");t&&(t.textContent=`${e}%`)}togglePlayPause(){const e=l.getState();e.isPlaying?l.pause():e.currentTrack&&e.currentAlbum&&(console.log("Now Playing: Resuming current track:",e.currentTrack.title),l.play(e.currentTrack.id,e.currentAlbum.id,{forceStart:!0,preservePosition:!0}).catch(t=>{console.error("Failed to resume playback:",t)}))}handleProgressClick(e){const i=e.currentTarget.getBoundingClientRect(),n=(e.clientX-i.left)/i.width,o=l.getState();if(o.duration&&!isNaN(o.duration)){const r=n*o.duration;l.seek(r)}}show(){this.isVisible||(this.isVisible=!0,this.collapsedElement.style.opacity="1",this.collapsedElement.style.pointerEvents="auto",this.sleepTimerButton&&!this.isExpanded&&!this.isActiveTimerVisible&&(this.sleepTimerButton.style.opacity="1",this.sleepTimerButton.style.pointerEvents="auto"),this.updateWidgetPosition())}hide(){this.isVisible&&(this.isVisible=!1,this.collapsedElement.style.opacity="0",this.collapsedElement.style.pointerEvents="none",this.sleepTimerButton&&(this.sleepTimerButton.style.opacity="0",this.sleepTimerButton.style.pointerEvents="none"))}expand(){this.isExpanded||(this.isExpanded=!0,this.wasActiveTimerVisibleBeforeExpand=this.isActiveTimerVisible,this.collapsedElement.style.opacity="0",this.collapsedElement.style.pointerEvents="none",this.expandedElement?.classList.remove("hidden"),this.sleepTimerButton&&(this.sleepTimerButton.style.opacity="0",this.sleepTimerButton.style.pointerEvents="none"),this.closeSleepTimer(),this.isActiveTimerVisible&&this.hideActiveTimerModal(),setTimeout(()=>{this.expandedContainer?.classList.remove("translate-y-full"),this.expandedContainer?.classList.add("translate-y-0")},10))}collapse(){this.isExpanded&&(this.isExpanded=!1,this.expandedContainer?.classList.add("translate-y-full"),this.expandedContainer?.classList.remove("translate-y-0"),setTimeout(()=>{if(this.expandedElement?.classList.add("hidden"),this.isVisible){this.collapsedElement.style.opacity="1",this.collapsedElement.style.pointerEvents="auto";const e=document.getElementById("timer-countdown");(e&&e.textContent!=="--:--"&&e.textContent!==""||this.wasActiveTimerVisibleBeforeExpand)&&this.sleepTimerEndTime?this.showActiveTimerModal():this.sleepTimerButton&&(this.sleepTimerButton.style.opacity="1",this.sleepTimerButton.style.pointerEvents="auto"),this.wasActiveTimerVisibleBeforeExpand=!1,this.updateWidgetPosition()}},300))}toggleSleepTimer(){if(this.isSleepTimerExpanded)this.closeSleepTimer();else{const e=document.getElementById("timer-countdown");e&&e.textContent!=="--:--"&&e.textContent!==""?this.showActiveTimerModal():this.openSleepTimer()}}openSleepTimer(){this.sleepTimerPopup&&(this.isSleepTimerExpanded=!0,this.sleepTimerPopup.classList.remove("hidden"),setTimeout(()=>{this.sleepTimerPopup.classList.remove("translate-y-full"),this.sleepTimerPopup.classList.add("translate-y-0")},10))}closeSleepTimer(){!this.sleepTimerPopup||!this.isSleepTimerExpanded||(this.isSleepTimerExpanded=!1,this.sleepTimerPopup.classList.add("translate-y-full"),this.sleepTimerPopup.classList.remove("translate-y-0"),setTimeout(()=>{this.sleepTimerPopup.classList.add("hidden")},300))}selectSleepTimer(e){console.log(`🛌 Sleep timer set for ${e} minutes`),this.lastTimerDuration=e,this.startSleepTimer(e),this.transitionToActiveTimer()}cancelSleepTimer(){if(document.getElementById("cancel-timer")?.textContent?.trim()==="Restart")if(console.log("🛌 Restarting sleep timer with same duration"),this.lastTimerDuration){this.startSleepTimer(this.lastTimerDuration);const i=l.getState();i.currentTrack&&i.currentAlbum&&!i.isPlaying&&l.play(i.currentTrack.id,i.currentAlbum.id,{forceStart:!0,preservePosition:!0}).catch(s=>{console.error("Failed to resume music on timer restart:",s)}),console.log(`🛌 Restarted ${this.lastTimerDuration} minute timer and resumed music`)}else{console.warn("🛌 No previous timer duration found, cannot restart"),this.updateTimerButton(!1);const i=document.getElementById("timer-countdown");i&&(i.textContent="Error")}else{console.log("🛌 Sleep timer cancelled"),this.stopSleepTimer();const i=document.getElementById("timer-countdown");i&&(i.textContent="--:--"),this.updateTimerButton(!1),this.hideActiveTimerModal()}}showActiveTimerModal(){this.activeTimerModal&&(this.isActiveTimerVisible=!0,this.activeTimerModal.classList.remove("hidden"),this.activeTimerModal.style.opacity="0",this.activeTimerModal.style.transition="opacity 0.3s ease, transform 0.3s ease",this.sleepTimerButton&&(this.sleepTimerButton.style.opacity="0",this.sleepTimerButton.style.pointerEvents="none"),setTimeout(()=>{this.activeTimerModal.classList.remove("translate-y-full"),this.activeTimerModal.classList.add("translate-y-0"),this.activeTimerModal.style.opacity="1"},10))}hideActiveTimerModal(){!this.activeTimerModal||!this.isActiveTimerVisible||(this.isActiveTimerVisible=!1,this.activeTimerModal.style.transition="opacity 0.3s ease, transform 0.3s ease",this.activeTimerModal.style.opacity="0",this.activeTimerModal.classList.add("translate-y-full"),this.activeTimerModal.classList.remove("translate-y-0"),this.sleepTimerButton&&this.isVisible&&!this.isExpanded&&(this.sleepTimerButton.style.opacity="1",this.sleepTimerButton.style.pointerEvents="auto"),setTimeout(()=>{this.activeTimerModal.classList.add("hidden"),this.activeTimerModal.style.opacity="",this.activeTimerModal.style.transition=""},300))}minimizeActiveTimerModal(){this.hideActiveTimerModal(),console.log("🛌 Sleep timer modal minimized - timer continues running")}transitionToActiveTimer(){!this.sleepTimerPopup||!this.activeTimerModal||(this.isSleepTimerExpanded=!1,this.sleepTimerButton&&(this.sleepTimerButton.style.opacity="0",this.sleepTimerButton.style.pointerEvents="none"),this.sleepTimerPopup.style.transition="opacity 0.3s ease",this.sleepTimerPopup.style.opacity="0",this.isActiveTimerVisible=!0,this.activeTimerModal.classList.remove("hidden"),this.activeTimerModal.classList.remove("translate-y-full"),this.activeTimerModal.classList.add("translate-y-0"),this.activeTimerModal.style.transition="opacity 0.3s ease",this.activeTimerModal.style.opacity="0",setTimeout(()=>{this.activeTimerModal.style.opacity="1"},300),setTimeout(()=>{this.sleepTimerPopup.classList.add("hidden"),this.sleepTimerPopup.classList.add("translate-y-full"),this.sleepTimerPopup.classList.remove("translate-y-0"),this.sleepTimerPopup.style.opacity="",this.sleepTimerPopup.style.transition="",this.activeTimerModal.style.transition=""},600))}startSleepTimer(e){this.stopSleepTimer(),this.sleepTimerEndTime=Date.now()+e*60*1e3;const t=l.getState();!t.isPlaying&&t.currentTrack?(this.sleepTimerPaused=!0,this.sleepTimerPausedAt=Date.now(),console.log("🛌 Sleep timer started in paused state (music not playing)")):(this.sleepTimerPaused=!1,this.sleepTimerPausedAt=null,console.log("🛌 Sleep timer started (music playing)")),this.updateTimerButton(!1),this.saveSleepTimerState(),this.sleepTimerInterval=window.setInterval(()=>{this.updateSleepTimerDisplay()},1e3),this.updateSleepTimerDisplay(),console.log(`🛌 Sleep timer started for ${e} minutes`)}stopSleepTimer(){this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerEndTime=null,this.sleepTimerPaused=!1,this.sleepTimerPausedAt=null,this.clearSleepTimerState(),console.log("🛌 Sleep timer stopped")}updateSleepTimerDisplay(){if(!this.sleepTimerEndTime)return;const e=document.getElementById("timer-countdown");if(!e||this.sleepTimerPaused)return;const t=Date.now(),i=Math.max(0,this.sleepTimerEndTime-t);if(i<=0){this.onSleepTimerComplete();return}const s=Math.ceil(i/1e3),n=Math.floor(s/60),o=s%60;e.textContent=`${n}:${o.toString().padStart(2,"0")}`}pauseSleepTimer(){!this.sleepTimerEndTime||this.sleepTimerPaused||(console.log("🛌 Sleep timer paused (music paused)"),this.sleepTimerPaused=!0,this.sleepTimerPausedAt=Date.now(),this.saveSleepTimerState())}resumeSleepTimer(){if(!this.sleepTimerEndTime||!this.sleepTimerPaused||!this.sleepTimerPausedAt)return;console.log("🛌 Sleep timer resumed (music resumed)");const e=Date.now()-this.sleepTimerPausedAt;this.sleepTimerEndTime+=e,this.sleepTimerPaused=!1,this.sleepTimerPausedAt=null,this.updateSleepTimerDisplay(),this.saveSleepTimerState()}onSleepTimerComplete(){console.log("🛌 Sleep timer completed - pausing music"),this.stopSleepTimer(),l.pause();const e=document.getElementById("timer-countdown");e&&(e.textContent="Time's up!"),this.updateTimerButton(!0),this.isActiveTimerVisible||this.showActiveTimerModal(),console.log("🛌 Sleep timer completed - modal kept open with restart option")}updateTimerButton(e){const t=document.getElementById("cancel-timer");t&&(t.textContent=e?"Restart":"Cancel")}saveSleepTimerState(){if(this.sleepTimerEndTime)try{const e={endTime:this.sleepTimerEndTime,isActive:!0,savedAt:Date.now(),lastDuration:this.lastTimerDuration,isPaused:this.sleepTimerPaused,pausedAt:this.sleepTimerPausedAt};localStorage.setItem("sleepTimerState",JSON.stringify(e))}catch(e){console.warn("Failed to save sleep timer state:",e)}}clearSleepTimerState(){try{localStorage.removeItem("sleepTimerState")}catch(e){console.warn("Failed to clear sleep timer state:",e)}}restoreSleepTimer(){try{const e=localStorage.getItem("sleepTimerState");if(!e)return;const t=JSON.parse(e);if(!t.isActive||!t.endTime)return;if(Date.now()>=t.endTime){this.clearSleepTimerState();return}this.sleepTimerEndTime=t.endTime,this.lastTimerDuration=t.lastDuration||null,this.sleepTimerPaused=t.isPaused||!1,this.sleepTimerPausedAt=t.pausedAt||null,this.sleepTimerInterval=window.setInterval(()=>{this.updateSleepTimerDisplay()},1e3),this.showActiveTimerModal(),this.updateSleepTimerDisplay(),console.log("🛌 Sleep timer restored from previous session")}catch(e){console.warn("Failed to restore sleep timer:",e),this.clearSleepTimerState()}}formatTime(e){if(isNaN(e))return"0:00";const t=Math.floor(e/60),i=Math.floor(e%60);return`${t}:${i.toString().padStart(2,"0")}`}destroy(){this.footerObserver&&this.footerObserver.disconnect(),this.stopSleepTimer()}}let c=null;function m(){c&&c.destroy(),c=new h}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m();document.addEventListener("astro:page-load",m);
