import{m as f}from"./music.CNPadTJM.js";class h{element;audio;globalAudio;trackData=null;albumData=null;isPlaying=!1;isLoop=!1;currentTrackIndex=0;isGloballyActive=!1;progressUpdateInterval=null;trackId;isShuffled=!1;shuffledOrder=[];originalOrder=[];constructor(t){this.element=t,this.audio=t.querySelector(".audio-element"),this.globalAudio=document.getElementById("global-audio-player"),this.trackId=t.dataset.trackId||"",this.init()}async init(){this.setupEventListeners(),this.loadTrackData(),this.checkIfGloballyActive(),this.startProgressUpdater(),this.loadLoopState(),this.initializeShuffleState()}initializeShuffleState(){this.albumData&&(this.originalOrder=Array.from({length:this.albumData.tracks.length},(t,e)=>e),this.generateShuffledOrder(),this.listenForShuffleStateChanges())}listenForShuffleStateChanges(){document.addEventListener("shuffleStateChanged",t=>{this.isShuffled=t.detail.isShuffled,this.isShuffled?(this.generateShuffledOrder(),console.log(`Track Player: Shuffle enabled for ${this.trackData?.title}`)):console.log(`Track Player: Shuffle disabled for ${this.trackData?.title}`)})}generateShuffledOrder(){if(this.albumData){this.shuffledOrder=[...this.originalOrder];for(let t=this.shuffledOrder.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[this.shuffledOrder[t],this.shuffledOrder[e]]=[this.shuffledOrder[e],this.shuffledOrder[t]]}console.log(`Track Player: Generated shuffle order for ${this.trackData?.title}:`,this.shuffledOrder)}}getCurrentOrder(){return this.isShuffled?this.shuffledOrder:this.originalOrder}findCurrentTrackInOrder(){return this.getCurrentOrder().indexOf(this.currentTrackIndex)}setupEventListeners(){this.element.querySelector(".play-pause-btn")?.addEventListener("click",()=>this.togglePlayPause());const e=this.element.querySelector(".prev-btn"),a=this.element.querySelector(".next-btn");e?.addEventListener("click",()=>this.previousTrack()),a?.addEventListener("click",()=>this.nextTrack()),this.element.querySelector(".loop-btn")?.addEventListener("click",()=>this.toggleLoop()),this.element.querySelector(".progress-container")?.addEventListener("click",s=>this.handleProgressClick(s)),this.element.querySelector(".volume-slider")?.addEventListener("input",s=>this.handleVolumeChange(s)),this.element.querySelector(".download-btn")?.addEventListener("click",()=>this.downloadTrack()),document.addEventListener("trackStarted",s=>{s.detail.title===this.trackData?.title?(this.isGloballyActive=!0,this.isPlaying=!0,this.updatePlayButton()):(this.isGloballyActive=!1,this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("trackPaused",()=>{this.isGloballyActive&&(this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("trackResumed",()=>{this.isGloballyActive&&(this.isPlaying=!0,this.updatePlayButton())}),document.addEventListener("trackStopped",()=>{this.isGloballyActive&&(this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("albumTrackChanged",s=>{const{actualTrackIndex:c,isAutoplay:d}=s.detail,r=document.querySelector(`[data-track-index="${c}"]`);r&&this.trackId===r.dataset?.trackId?(console.log(`Track Player: Highlighting track ${this.trackData?.title} during ${d?"autoplay":"manual"} navigation`),r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("highlight-track"),setTimeout(()=>{r.classList.remove("highlight-track")},3e3),this.isGloballyActive=!0,this.isPlaying=!0,this.updatePlayButton()):this.isGloballyActive&&(this.isGloballyActive=!1,this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("startGlobalPlayback",s=>{const{trackId:c,forceStart:d,override:r}=s.detail;c===this.trackId?(console.log(`Track Player: Track ${this.trackData?.title} started via global playback`),this.isGloballyActive=!0,this.isPlaying=!0,this.updatePlayButton()):this.isGloballyActive&&(d||r)&&(console.log(`Track Player: Track ${this.trackData?.title} stopped due to global override`),this.isGloballyActive=!1,this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("forceStopGlobalAudio",()=>{this.isGloballyActive&&(console.log(`Track Player: Force stopping ${this.trackData?.title}`),this.isGloballyActive=!1,this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("trackStarted",s=>{s.detail.title===this.trackData?.title?(console.log(`Track Player: Track ${this.trackData?.title} confirmed started`),this.isGloballyActive=!0,this.isPlaying=!0,this.updatePlayButton()):this.isGloballyActive&&(console.log(`Track Player: Track ${this.trackData?.title} stopped - another track started`),this.isGloballyActive=!1,this.isPlaying=!1,this.updatePlayButton())}),document.addEventListener("nowPlayingLoopChanged",s=>{s.detail.trackTitle===this.trackData?.title&&(this.isLoop=s.detail.isLoop,this.updateLoopButton(),this.saveLoopState())}),document.addEventListener("stopAllAudio",()=>{this.isPlaying&&this.pause()}),this.audio.addEventListener("loadedmetadata",()=>this.updateDuration()),this.audio.addEventListener("error",s=>this.onAudioError(s))}loadTrackData(){const t=this.element.dataset.trackId,e=this.element.dataset.albumId;try{this.albumData=f.albums.find(a=>a.id===e),this.albumData&&(this.trackData=this.albumData.tracks.find(a=>a.id===t),this.trackData&&(this.currentTrackIndex=this.albumData.tracks.findIndex(a=>a.id===t),this.updateTrackInfo(),this.loadAudio()))}catch(a){console.error("Failed to load track data:",a)}}checkIfGloballyActive(){try{const t=localStorage.getItem("nowPlayingState");if(t){const e=JSON.parse(t);if(e.trackData&&e.trackData.title===this.trackData?.title&&e.isVisible){this.isGloballyActive=!0,this.isPlaying=e.isPlaying||!1,this.updatePlayButton();const a=this.element.querySelector(".volume-slider");if(a&&e.volume!==void 0){const i=Math.round(e.volume*100);a.value=i.toString(),this.updateVolumeDisplay(i)}}}}catch(t){console.error("Failed to check global state:",t)}}updateTrackInfo(){if(!this.trackData)return;const t=this.element.querySelector(".track-title"),e=this.element.querySelector(".track-duration"),a=this.element.querySelector(".track-format");t&&(t.textContent=this.trackData.title),e&&(e.textContent=this.trackData.duration),a&&(a.className=`icon-${this.trackData.format?.toLowerCase()||"mp3"} text-palette-500 dark:text-palette-500 icon-lg track-format flex-shrink-0`)}loadAudio(){this.trackData&&(this.audio.src=this.trackData.file)}startProgressUpdater(){this.progressUpdateInterval=setInterval(()=>{this.isGloballyActive&&this.isPlaying&&this.globalAudio&&this.syncWithGlobalAudio()},100)}syncWithGlobalAudio(){if(!this.globalAudio)return;const t=this.globalAudio.currentTime,e=this.globalAudio.duration;if(e&&!isNaN(e)){const a=t/e*100,i=this.element.querySelector(".progress-bar");i&&(i.style.width=`${a}%`);const o=this.element.querySelector(".current-time"),l=this.element.querySelector(".total-time");o&&(o.textContent=this.formatTime(t)),l&&(l.textContent=this.formatTime(e))}}handleProgressClick(t){if(!this.isGloballyActive||!this.globalAudio)return;const a=t.currentTarget.getBoundingClientRect(),o=(t.clientX-a.left)/a.width;if(this.globalAudio.duration&&!isNaN(this.globalAudio.duration)){this.globalAudio.currentTime=o*this.globalAudio.duration;const l=this.element.querySelector(".progress-bar");l&&(l.style.width=`${o*100}%`);const n=this.element.querySelector(".current-time");n&&(n.textContent=this.formatTime(this.globalAudio.currentTime))}}handleVolumeChange(t){const e=t.target,a=parseInt(e.value),i=a/100;this.updateVolumeDisplay(a),this.globalAudio&&(this.globalAudio.volume=i),this.audio.volume=i;try{const o=localStorage.getItem("nowPlayingState");if(o){const l=JSON.parse(o);l.volume=i,localStorage.setItem("nowPlayingState",JSON.stringify(l))}}catch(o){console.error("Failed to save volume state:",o)}document.dispatchEvent(new CustomEvent("globalVolumeChange",{detail:{volume:a}}))}updateVolumeDisplay(t){const e=this.element.querySelector(".volume-display");e&&(e.textContent=`${t}%`)}togglePlayPause(){this.isGloballyActive?this.isPlaying?(console.log("Track Player: Pausing track:",this.trackData?.title),document.dispatchEvent(new CustomEvent("trackPaused"))):(console.log("Track Player: Resuming track:",this.trackData?.title),document.dispatchEvent(new CustomEvent("trackResumed"))):(console.log("Track Player: Starting new track:",this.trackData?.title),this.play())}play(){document.dispatchEvent(new CustomEvent("stopAllAudio")),document.dispatchEvent(new CustomEvent("trackStarted",{detail:{title:this.trackData?.title||"Unknown",album:this.albumData?.title||"Unknown Album",format:this.trackData?.format||"mp3",duration:this.trackData?.duration||"0:00",trackId:this.trackData?.id}})),this.isGloballyActive=!0,this.isPlaying=!0,this.updatePlayButton()}pause(){document.dispatchEvent(new CustomEvent("trackPaused")),this.isPlaying=!1,this.updatePlayButton()}updatePlayButton(){const t=this.element.querySelector(".play-icon"),e=this.element.querySelector(".pause-icon");this.isPlaying?(t&&(t.style.display="none"),e&&(e.style.display="inline-block")):(t&&(t.style.display="inline-block"),e&&(e.style.display="none"))}updateDuration(){const t=this.audio.duration,e=this.element.querySelector(".total-time");e&&t&&!isNaN(t)&&(e.textContent=this.formatTime(t))}formatTime(t){if(isNaN(t))return"0:00";const e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`}onAudioError(t){console.error("Audio error:",t),this.isPlaying=!1,this.updatePlayButton();const e=this.element.querySelector(".track-title");e&&(e.textContent="Audio file not available")}toggleLoop(){this.isLoop=!this.isLoop,this.updateLoopButton(),this.saveLoopState(),document.dispatchEvent(new CustomEvent("trackLoopChanged",{detail:{isLoop:this.isLoop,trackTitle:this.trackData?.title}})),console.log(`Track Player: Loop ${this.isLoop?"enabled":"disabled"} for track: ${this.trackData?.title}`)}updateLoopButton(){const t=this.element.querySelector(".loop-icon"),e=this.element.querySelector(".loop-one-icon"),a=this.element.querySelector(".loop-btn");this.isLoop?(t&&(t.style.display="none"),e&&(e.style.display="inline-block"),a&&(a.classList.remove("text-palette-800","dark:text-palette-300"),a.classList.add("text-palette-300","dark:text-palette-400"),a.setAttribute("title","Loop Track (Active)"))):(t&&(t.style.display="inline-block"),e&&(e.style.display="none"),a&&(a.classList.add("text-palette-800","dark:text-palette-300"),a.classList.remove("text-palette-300","dark:text-palette-400"),a.setAttribute("title","Loop Track")))}saveLoopState(){try{const t=JSON.parse(localStorage.getItem("trackLoopStates")||"{}");t[this.trackId]=this.isLoop,localStorage.setItem("trackLoopStates",JSON.stringify(t))}catch(t){console.error("Failed to save loop state:",t)}}loadLoopState(){try{const t=JSON.parse(localStorage.getItem("trackLoopStates")||"{}");this.isLoop=t[this.trackId]||!1,this.updateLoopButton()}catch(t){console.error("Failed to load loop state:",t),this.isLoop=!1}}previousTrack(){if(this.isLoop=!1,this.updateLoopButton(),this.saveLoopState(),document.dispatchEvent(new CustomEvent("trackLoopChanged",{detail:{isLoop:!1,trackTitle:this.trackData?.title}})),!this.albumData)return;const t=this.getCurrentOrder(),e=this.findCurrentTrackInOrder();let a;e<=0?a=t.length-1:a=e-1;const i=t[a];this.navigateToTrack(i),console.log(`Track Player: Previous track navigation - from position ${e} to ${a} (track index ${i}) - Shuffle: ${this.isShuffled?"ON":"OFF"}`)}nextTrack(){if(this.isLoop=!1,this.updateLoopButton(),this.saveLoopState(),document.dispatchEvent(new CustomEvent("trackLoopChanged",{detail:{isLoop:!1,trackTitle:this.trackData?.title}})),!this.albumData)return;const t=this.getCurrentOrder(),e=this.findCurrentTrackInOrder();let a;e>=t.length-1?a=0:a=e+1;const i=t[a];this.navigateToTrack(i),console.log(`Track Player: Next track navigation - from position ${e} to ${a} (track index ${i}) - Shuffle: ${this.isShuffled?"ON":"OFF"}`)}navigateToTrack(t){if(!this.albumData||t<0||t>=this.albumData.tracks.length)return;const e=this.albumData.tracks[t],a=document.querySelector(`[data-track-index="${t}"]`);if(a){console.log(`Track Player: Navigating to track ${e.title} and starting playback`),a.scrollIntoView({behavior:"smooth",block:"center"}),a.classList.add("highlight-track"),setTimeout(()=>{a.classList.remove("highlight-track")},3e3),document.dispatchEvent(new CustomEvent("stopAllAudio")),document.dispatchEvent(new CustomEvent("forceStopGlobalAudio"));const i={title:e.title,album:this.albumData.title,format:e.format,duration:e.duration,trackId:e.id,albumId:this.albumData.id,file:e.file};setTimeout(()=>{document.dispatchEvent(new CustomEvent("startGlobalPlayback",{detail:{...i,forceStart:!0,navigationPlayback:!0,shuffleState:this.isShuffled,trackIndex:this.findPositionInOrder(t),actualTrackIndex:t}})),setTimeout(()=>{document.dispatchEvent(new CustomEvent("trackStarted",{detail:i}))},200)},300),document.dispatchEvent(new CustomEvent("albumTrackChanged",{detail:{trackIndex:this.findPositionInOrder(t),actualTrackIndex:t,isShuffled:this.isShuffled,isAutoplay:!1}}))}}findPositionInOrder(t){return this.getCurrentOrder().indexOf(t)}downloadTrack(){if(!this.trackData)return;const t=document.createElement("a");t.href=this.trackData.file,t.download=`${this.trackData.title}.${this.trackData.format}`,document.body.appendChild(t),t.click(),document.body.removeChild(t)}destroy(){this.progressUpdateInterval&&clearInterval(this.progressUpdateInterval)}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".track-player").forEach(t=>{new h(t)})});document.addEventListener("astro:page-load",()=>{document.querySelectorAll(".track-player").forEach(t=>{new h(t)})});
