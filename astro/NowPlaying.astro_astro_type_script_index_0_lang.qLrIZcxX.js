import{m as g}from"./music.CZ3oZcc0.js";class m{collapsedElement;expandedElement;expandedContainer;globalAudio;currentTrackData=null;currentAlbumData=null;currentTrackIndex=0;isVisible=!1;isExpanded=!1;isPlaying=!1;isLoop=!1;currentVolume=.7;progressUpdateInterval=null;stateCheckInterval=null;lastSavedTime=0;isTabActive=!0;audioContext=null;gainNode=null;source=null;hasUserInteracted=!1;pendingPlayback=null;footerObserver=null;constructor(){this.collapsedElement=document.getElementById("now-playing-collapsed"),this.expandedElement=document.getElementById("now-playing-expanded"),this.expandedContainer=document.getElementById("now-playing-card"),this.globalAudio=document.getElementById("global-audio-player"),!(!this.collapsedElement||!this.expandedElement||!this.globalAudio)&&this.init()}init(){this.setupAudioContext(),this.setupEventListeners(),this.setupGlobalAudio(),this.listenForTrackChanges(),this.setupVisibilityHandling(),this.setupFooterOverlapPrevention(),this.restoreState(),this.startProgressUpdater(),this.startStateChecker()}setupFooterOverlapPrevention(){this.footerObserver=new IntersectionObserver(a=>{a.forEach(i=>{i.isIntersecting,this.updateWidgetPosition()})},{root:null,rootMargin:"0px",threshold:.1});const e=document.querySelector("footer");e&&this.footerObserver&&this.footerObserver.observe(e);let t=null;window.addEventListener("scroll",()=>{t&&clearTimeout(t),t=setTimeout(()=>{this.updateWidgetPosition()},10)}),window.addEventListener("resize",()=>{this.updateWidgetPosition()})}updateWidgetPosition(){if(!this.collapsedElement||!this.isVisible||this.isExpanded)return;const e=document.querySelector("footer");if(!e)return;const t=e.getBoundingClientRect(),a=window.innerHeight,i=16;let o=i;t.top<a&&(o=a-t.top+i+10),this.collapsedElement.style.bottom=`${o}px`,this.collapsedElement.style.transition="bottom 0.3s ease, opacity 0.3s ease, scale 0.2s cubic-bezier(0.4, 0, 0.2, 1)"}setupAudioContext(){}async createAudioContextIfNeeded(){if(!this.hasUserInteracted)return!1;if(!this.audioContext)try{return this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.source=this.audioContext.createMediaElementSource(this.globalAudio),this.source.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.currentVolume,console.log("ðŸŽµ AudioContext created successfully after user interaction"),!0}catch(e){return console.warn("Web Audio API not supported, falling back to standard audio:",e),!1}if(this.audioContext.state==="suspended")try{return await this.audioContext.resume(),console.log("ðŸŽµ AudioContext resumed successfully"),!0}catch(e){return console.warn("Failed to resume AudioContext:",e),!1}return!0}setupVisibilityHandling(){document.addEventListener("visibilitychange",()=>{this.isTabActive=!document.hidden,this.isTabActive&&this.hasUserInteracted?this.checkAndRestorePlayback():this.saveState()}),window.addEventListener("focus",()=>{this.isTabActive=!0,this.hasUserInteracted&&this.checkAndRestorePlayback()}),window.addEventListener("blur",()=>{this.isTabActive=!1,this.saveState()}),window.addEventListener("beforeunload",()=>{this.saveState()}),window.addEventListener("pageshow",e=>{e.persisted&&this.hasUserInteracted&&this.checkAndRestorePlayback()}),window.addEventListener("pagehide",()=>{this.saveState()})}checkAndRestorePlayback(){if(!this.hasUserInteracted){console.log("ðŸ”‡ Skipping playback restoration - no user interaction yet");return}setTimeout(()=>{try{const e=localStorage.getItem("nowPlayingState");if(e){const t=JSON.parse(e);t.isPlaying&&t.audioSrc&&this.globalAudio.src!==t.audioSrc?(this.globalAudio.src=t.audioSrc,this.globalAudio.currentTime=t.currentTime||0,this.globalAudio.play().then(()=>{console.log("ðŸŽµ Successfully restored playback after page focus")}).catch(a=>{console.log("ðŸ”‡ Could not auto-resume playback (user interaction required):",a.message)})):t.isPlaying&&this.globalAudio.paused&&this.globalAudio.play().then(()=>{console.log("ðŸŽµ Successfully resumed playback")}).catch(a=>{console.log("ðŸ”‡ Could not resume playback (user interaction required):",a.message)})}}catch(e){console.error("Failed to restore playback:",e)}},100)}setupGlobalAudio(){this.globalAudio.volume=this.currentVolume,this.globalAudio.setAttribute("playsinline","true"),this.globalAudio.setAttribute("webkit-playsinline","true"),this.globalAudio.addEventListener("loadedmetadata",()=>this.updateDuration()),this.globalAudio.addEventListener("timeupdate",()=>this.updateProgress()),this.globalAudio.addEventListener("ended",()=>this.onTrackEnd()),this.globalAudio.addEventListener("error",e=>this.onAudioError(e)),this.globalAudio.addEventListener("play",()=>{this.isPlaying=!0,this.updatePlayButton(!0),this.saveState(),this.hasUserInteracted=!0,this.createAudioContextIfNeeded()}),this.globalAudio.addEventListener("pause",()=>{this.isPlaying=!1,this.updatePlayButton(!1),this.saveState()}),this.globalAudio.addEventListener("suspend",()=>{this.saveState()}),this.globalAudio.addEventListener("resume",()=>{this.hasUserInteracted&&this.checkAndRestorePlayback()}),this.globalAudio.addEventListener("stalled",()=>{console.warn("Audio stalled, attempting to resume..."),this.isPlaying&&this.hasUserInteracted&&setTimeout(()=>{this.globalAudio.play().catch(e=>{console.error("Failed to resume after stall:",e)})},1e3)}),this.globalAudio.addEventListener("waiting",()=>{console.log("Audio waiting for data...")}),this.globalAudio.addEventListener("canplaythrough",()=>{console.log("Audio can play through"),this.isPlaying&&this.globalAudio.paused&&this.hasUserInteracted&&this.globalAudio.play().catch(e=>{console.error("Failed to resume after canplaythrough:",e)})})}setupEventListeners(){const e=document.getElementById("expand-now-playing"),t=document.getElementById("collapse-now-playing");e?.addEventListener("click",s=>{s.stopPropagation(),this.expand()}),t?.addEventListener("click",()=>this.collapse()),this.collapsedElement?.addEventListener("click",()=>this.expand()),this.expandedElement?.addEventListener("click",s=>{s.target===this.expandedElement&&this.collapse()});const a=document.getElementById("expanded-play-pause"),i=document.getElementById("expanded-prev"),o=document.getElementById("expanded-next"),n=document.getElementById("expanded-loop");a?.addEventListener("click",()=>this.togglePlayPause()),i?.addEventListener("click",()=>this.previousTrack()),o?.addEventListener("click",()=>this.nextTrack()),n?.addEventListener("click",()=>this.toggleLoop());const r=this.collapsedElement?.querySelector(".mini-progress-container-collapsed"),l=this.expandedElement?.querySelector(".expanded-progress-container");r?.addEventListener("click",s=>{s.stopPropagation(),this.seek(s)}),l?.addEventListener("click",s=>this.seek(s)),this.expandedElement?.querySelector(".expanded-volume-slider")?.addEventListener("input",s=>{const p=parseInt(s.target.value);this.setVolume(p),this.updateVolumeDisplay(p),this.hasUserInteracted=!0}),document.addEventListener("keydown",s=>{if(!["INPUT","TEXTAREA"].includes(s.target.tagName))switch(s.key){case" ":s.preventDefault(),this.hasUserInteracted=!0,this.togglePlayPause();break;case"ArrowLeft":s.preventDefault(),this.hasUserInteracted=!0,this.previousTrack();break;case"ArrowRight":s.preventDefault(),this.hasUserInteracted=!0,this.nextTrack();break;case"l":case"L":s.preventDefault(),this.hasUserInteracted=!0,this.toggleLoop();break;case"Escape":this.isExpanded&&(s.preventDefault(),this.collapse());break}})}listenForTrackChanges(){document.addEventListener("trackStarted",e=>{this.hasUserInteracted=!0,this.startGlobalPlayback(e.detail)}),document.addEventListener("trackPaused",()=>{!this.globalAudio.paused&&this.hasUserInteracted&&this.globalAudio.pause()}),document.addEventListener("trackResumed",()=>{this.globalAudio.paused&&this.hasUserInteracted&&this.globalAudio.play().catch(e=>{console.error("Failed to resume playback:",e)})}),document.addEventListener("trackStopped",()=>{this.hasUserInteracted&&this.globalAudio.pause()}),document.addEventListener("trackLoopChanged",e=>{this.isLoop=e.detail.isLoop,this.updateLoopButton(),this.saveState()}),document.addEventListener("astro:before-preparation",()=>{this.saveState()}),document.addEventListener("astro:page-load",()=>{setTimeout(()=>{this.restoreStateWithoutAutoplay()},100)})}startGlobalPlayback(e){const t=this.currentTrackData&&this.currentTrackData.title===e.title&&this.globalAudio.src;this.updateNowPlaying(e),t?(console.log("Resuming same track from position:",this.globalAudio.currentTime),this.globalAudio.paused&&this.hasUserInteracted&&this.globalAudio.play().catch(a=>{console.error("Failed to resume same track:",a)})):(console.log("Loading new track:",e.title),this.loadAndPlayTrack(e)),this.show(),this.saveState()}loadAndPlayTrack(e){let t="";for(const a of g.albums){const i=a.tracks.find(o=>o.title===e.title);if(i){t=i.file;break}}t&&(this.globalAudio.src!==t&&(this.globalAudio.src=t,this.globalAudio.currentTime=0),this.createAudioContextIfNeeded(),this.hasUserInteracted?this.globalAudio.play().catch(a=>{console.error("Failed to play global audio:",a)}):(this.pendingPlayback={trackData:e},console.log("ðŸ”‡ Playback pending user interaction")))}updateNowPlaying(e){this.currentTrackData=e,this.currentAlbumData=g.albums.find(l=>l.tracks.some(h=>h.title===e.title)),this.currentAlbumData&&(this.currentTrackIndex=this.currentAlbumData.tracks.findIndex(l=>l.title===e.title)),this.loadLoopState();const t=this.collapsedElement?.querySelector(".now-playing-title-collapsed"),a=this.collapsedElement?.querySelector(".now-playing-album-collapsed");t&&(t.textContent=e.title||"Unknown Track"),a&&(a.textContent=e.album||"Unknown Album");const i=this.expandedElement?.querySelector(".now-playing-title-expanded"),o=this.expandedElement?.querySelector(".now-playing-album-expanded"),n=this.expandedElement?.querySelector(".now-playing-album-art"),r=this.expandedElement?.querySelector(".now-playing-release-date");if(i&&(i.textContent=e.title||"Unknown Track"),o&&(o.textContent=e.album||"Unknown Album"),n&&this.currentAlbumData&&(n.src=this.currentAlbumData.coverArt||"/art/default-cover.png",n.alt=`${this.currentAlbumData.title} album cover`),r&&this.currentAlbumData){const l=new Date(this.currentAlbumData.releaseDate).toLocaleDateString();r.textContent=`Released ${l}`}}updatePlayButton(e){const t=this.expandedElement?.querySelector(".expanded-play-icon"),a=this.expandedElement?.querySelector(".expanded-pause-icon");e?(t&&(t.style.display="none"),a&&(a.style.display="inline-block")):(t&&(t.style.display="inline-block"),a&&(a.style.display="none"))}updateProgress(){const e=this.globalAudio.currentTime,t=this.globalAudio.duration;if(t&&!isNaN(t)){const a=e/t*100,i=this.collapsedElement?.querySelector(".mini-progress-bar-collapsed");i&&(i.style.width=`${a}%`);const o=this.expandedElement?.querySelector(".expanded-progress-bar"),n=this.expandedElement?.querySelector(".expanded-current-time"),r=this.expandedElement?.querySelector(".expanded-total-time");o&&(o.style.width=`${a}%`),n&&(n.textContent=this.formatTime(e)),r&&(r.textContent=this.formatTime(t)),Math.abs(e-this.lastSavedTime)>5&&(this.lastSavedTime=e,this.saveState())}}updateDuration(){const e=this.globalAudio.duration,t=this.expandedElement?.querySelector(".expanded-total-time");t&&e&&!isNaN(e)&&(t.textContent=this.formatTime(e))}formatTime(e){if(isNaN(e))return"0:00";const t=Math.floor(e/60),a=Math.floor(e%60);return`${t}:${a.toString().padStart(2,"0")}`}onTrackEnd(){this.isPlaying=!1,this.updatePlayButton(!1),this.isLoop?(console.log(`Now Playing: Looping track: ${this.currentTrackData?.title}`),this.globalAudio.currentTime=0,setTimeout(()=>{this.globalAudio.play().then(()=>{this.isPlaying=!0,this.updatePlayButton(!0),console.log(`Now Playing: Successfully looped track: ${this.currentTrackData?.title}`)}).catch(e=>{console.error("Now Playing: Failed to loop track:",e)})},50)):this.nextTrack()}onAudioError(e){console.error("Global audio error:",e),this.isPlaying=!1,this.updatePlayButton(!1)}startProgressUpdater(){this.progressUpdateInterval=setInterval(()=>{this.isPlaying&&!this.globalAudio.paused&&this.updateProgress()},100)}startStateChecker(){this.stateCheckInterval=setInterval(()=>{this.isPlaying&&this.globalAudio.paused&&(console.log("Detected unexpected pause, attempting to resume..."),this.globalAudio.play().catch(e=>{console.warn("Failed to auto-resume:",e)})),this.isPlaying&&this.saveState()},2e3)}show(){this.isVisible||(this.isVisible=!0,this.collapsedElement.style.opacity="1",this.collapsedElement.style.pointerEvents="auto",this.updateWidgetPosition())}expand(){this.isExpanded||(this.isExpanded=!0,this.collapsedElement.style.opacity="0",this.collapsedElement.style.pointerEvents="none",this.expandedElement?.classList.remove("hidden"),setTimeout(()=>{this.expandedContainer?.classList.remove("translate-y-full"),this.expandedContainer?.classList.add("translate-y-0")},10))}collapse(){this.isExpanded&&(this.isExpanded=!1,this.expandedContainer?.classList.add("translate-y-full"),this.expandedContainer?.classList.remove("translate-y-0"),setTimeout(()=>{this.expandedElement?.classList.add("hidden"),this.isVisible&&(this.collapsedElement.style.opacity="1",this.collapsedElement.style.pointerEvents="auto",this.updateWidgetPosition())},300))}togglePlayPause(){this.hasUserInteracted=!0,this.globalAudio.src&&this.currentTrackData?this.isPlaying?(console.log("Pausing at position:",this.globalAudio.currentTime),this.globalAudio.pause()):(console.log("Resuming from position:",this.globalAudio.currentTime),this.createAudioContextIfNeeded(),this.globalAudio.play().catch(e=>{console.error("Failed to resume audio:",e)})):(console.warn("No track loaded to play/pause"),this.pendingPlayback&&(console.log("ðŸŽµ Starting pending playback after user interaction"),this.startGlobalPlayback(this.pendingPlayback.trackData),this.pendingPlayback=null))}toggleLoop(){this.hasUserInteracted=!0,this.isLoop=!this.isLoop,this.updateLoopButton(),this.saveLoopState(),document.dispatchEvent(new CustomEvent("nowPlayingLoopChanged",{detail:{isLoop:this.isLoop,trackTitle:this.currentTrackData?.title}})),console.log(`Now Playing: Loop ${this.isLoop?"enabled":"disabled"} for track: ${this.currentTrackData?.title}`)}updateLoopButton(){const e=this.expandedElement?.querySelector(".expanded-loop-icon"),t=this.expandedElement?.querySelector(".expanded-loop-one-icon"),a=this.expandedElement?.querySelector("#expanded-loop");this.isLoop?(e&&(e.style.display="none"),t&&(t.style.display="inline-block"),a&&(a.classList.remove("text-palette-800","dark:text-palette-300"),a.classList.add("text-palette-800","dark:text-palette-400"),a.setAttribute("title","Loop Track (Active)"))):(e&&(e.style.display="inline-block"),t&&(t.style.display="none"),a&&(a.classList.add("text-palette-800","dark:text-palette-300"),a.classList.remove("text-palette-800","dark:text-palette-400"),a.setAttribute("title","Loop Track")))}saveLoopState(){if(this.currentTrackData)try{const e=JSON.parse(localStorage.getItem("trackLoopStates")||"{}"),t=this.getTrackId();t&&(e[t]=this.isLoop,localStorage.setItem("trackLoopStates",JSON.stringify(e)))}catch(e){console.error("Failed to save loop state:",e)}}loadLoopState(){if(this.currentTrackData)try{const e=JSON.parse(localStorage.getItem("trackLoopStates")||"{}"),t=this.getTrackId();t&&(this.isLoop=e[t]||!1,this.updateLoopButton())}catch(e){console.error("Failed to load loop state:",e),this.isLoop=!1}}getTrackId(){return!this.currentTrackData||!this.currentAlbumData?null:this.currentAlbumData.tracks.find(t=>t.title===this.currentTrackData.title)?.id||null}previousTrack(){if(this.hasUserInteracted=!0,this.isLoop=!1,this.updateLoopButton(),this.saveLoopState(),!!this.currentAlbumData){if(this.currentTrackIndex===0){console.log("First track - restarting from 0:00"),this.globalAudio.currentTime=0,!this.isPlaying&&this.hasUserInteracted&&this.globalAudio.play().catch(e=>{console.error("Failed to restart track:",e)});return}this.navigateToTrack(this.currentTrackIndex-1)}}nextTrack(){this.hasUserInteracted=!0,this.isLoop=!1,this.updateLoopButton(),this.saveLoopState(),this.currentAlbumData&&(this.currentTrackIndex===this.currentAlbumData.tracks.length-1?(console.log("Last track - returning to first track"),this.navigateToTrack(0)):this.navigateToTrack(this.currentTrackIndex+1))}navigateToTrack(e){if(!this.currentAlbumData||e<0||e>=this.currentAlbumData.tracks.length)return;const t=this.currentAlbumData.tracks[e],a={title:t.title,album:this.currentAlbumData.title,format:t.format,duration:t.duration};this.currentTrackIndex=e,this.updateNowPlaying(a),this.loadAndPlayTrack(a),this.saveState()}seek(e){const a=e.currentTarget.getBoundingClientRect(),o=(e.clientX-a.left)/a.width;this.globalAudio.duration&&!isNaN(this.globalAudio.duration)&&(this.globalAudio.currentTime=o*this.globalAudio.duration,this.saveState())}setVolume(e){this.hasUserInteracted=!0,this.currentVolume=e/100,this.globalAudio.volume=this.currentVolume,this.gainNode&&(this.gainNode.gain.value=this.currentVolume),this.saveState()}updateVolumeDisplay(e){const t=this.expandedElement?.querySelector(".expanded-volume-display");t&&(t.textContent=`${e}%`)}saveState(){if(this.currentTrackData){const e={trackData:this.currentTrackData,albumData:this.currentAlbumData,trackIndex:this.currentTrackIndex,isVisible:this.isVisible,isPlaying:this.isPlaying,isLoop:this.isLoop,currentTime:this.globalAudio.currentTime||0,volume:this.currentVolume,audioSrc:this.globalAudio.src,timestamp:Date.now()};localStorage.setItem("nowPlayingState",JSON.stringify(e))}}restoreState(){this.restoreStateWithoutAutoplay()}restoreStateWithoutAutoplay(){try{const e=localStorage.getItem("nowPlayingState");if(e){const t=JSON.parse(e);if(Date.now()-(t.timestamp||0)>24*60*60*1e3){localStorage.removeItem("nowPlayingState");return}if(t.trackData&&t.isVisible){this.currentTrackData=t.trackData,this.currentAlbumData=t.albumData,this.currentTrackIndex=t.trackIndex,this.currentVolume=t.volume||.7,this.isLoop=t.isLoop||!1,t.audioSrc?(this.globalAudio.src=t.audioSrc,this.globalAudio.volume=this.currentVolume,this.gainNode&&(this.gainNode.gain.value=this.currentVolume),t.currentTime&&(this.globalAudio.currentTime=t.currentTime),t.isPlaying?(console.log("ðŸ”‡ Playback state restored but waiting for user interaction to resume"),this.pendingPlayback={trackData:t.trackData},this.isPlaying=!1,this.updatePlayButton(!1)):(this.isPlaying=!1,this.updatePlayButton(!1))):(this.isPlaying=!1,this.updatePlayButton(!1)),this.updateNowPlaying(t.trackData),this.updateLoopButton();const i=this.expandedElement?.querySelector(".expanded-volume-slider");i&&(i.value=(this.currentVolume*100).toString(),this.updateVolumeDisplay(this.currentVolume*100)),this.show()}}}catch(e){console.error("Failed to restore now playing state:",e),localStorage.removeItem("nowPlayingState")}}handleFirstInteraction(){this.hasUserInteracted||(this.hasUserInteracted=!0,console.log("ðŸŽµ First user interaction detected - audio now enabled"),this.createAudioContextIfNeeded(),this.pendingPlayback&&(console.log("ðŸŽµ Starting pending playback after first interaction"),this.startGlobalPlayback(this.pendingPlayback.trackData),this.pendingPlayback=null))}destroy(){this.progressUpdateInterval&&clearInterval(this.progressUpdateInterval),this.stateCheckInterval&&clearInterval(this.stateCheckInterval),this.footerObserver&&this.footerObserver.disconnect(),this.source&&this.source.disconnect(),this.gainNode&&this.gainNode.disconnect(),this.audioContext&&this.audioContext.close()}}let c=null;function u(){c&&c.destroy(),c=new m;const d=()=>{c&&c.handleFirstInteraction(),document.removeEventListener("click",d),document.removeEventListener("keydown",e),document.removeEventListener("touchstart",t)},e=a=>{["Tab","Shift","Control","Alt","Meta"].includes(a.key)||d()},t=()=>{d()};document.addEventListener("click",d,{once:!0}),document.addEventListener("keydown",e,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("astro:page-load",u);
